tycho2 build and test notes for the "vortex" machine at SNL.

Date: 06/30/2021
By: Glen Hansen "gahanse@sandia.gov"

1. Bsub to a couple of compute nodes

   lalloc 2

2. Edit ./do-configure file and point to the correct Kokkos "nvcc_wrapper" and "metis-5.1.0" installation.

3. Need to edit the "nvcc_wrapper" for this machine and CUDA 11. Make the following changes:

   Line 15: change default_arch="sm_35" to
   default_arch="sm_70"

   Line 416: change nvcc_command="$nvcc_command $compile_arg $output_arg" to
   nvcc_command="$nvcc_command -Xcompiler -mno-float128 -expt-extended-lambda $compile_arg $output_arg" 

4. Set the modules at login (need to set in a dot file so "lalloc" will pick these up on each node)

    module load cuda/11.2.0
    module load gcc/8.3.1
    module load cmake/3.18.0
    module load git/2.29.1
    module load lapack/3.9.0-gcc-7.3.1

   Note: The "backend" nodes on vortex apparently "automagically" prefix your PATH with "/usr/local/cuda/bin", which adds 
   pre-CUDA 11 binaries (specifically a pre-CUDA 11 version of nvcc) that breaks builds that rely on CUDA 11 capabilies. 
   "tycho2" does not - but if you need a CUDA >= 11 environment you need to strip this from your PATH and LD_LIBRARY_PATH, 
   possibly using (in .bashrc):

   export PATH=${PATH/"/usr/local/cuda/bin:"/}
   export LD_LIBRARY_PATH=${LD_LIBRARY_PATH/"/usr/local/cuda/lib64:"/}

5. Make a "build" directory somewhere

   mkdir /vscratch1/some_user/build
   cd /vscratch1/some_user/build

6. Export vortex directory location as an environment variable

   For the export command below, be sure to be in the tycho2/vortex directory so that the `pwd` command 
   gives the correct directory:

   export VTX_DIR=`pwd`

7. Configure

   $VTX_DIR/do-configure $VTX_DIR/..

8. Make it

   make -j16

9. Run small test on 2 nodes while in the build directory

   cp $VTX_DIR/vortex.sh .

   ./vortex.sh $VTX_DIR/.. 2

   Results are in temp.pmesh file.
